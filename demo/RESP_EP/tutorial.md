# Tutorial: OBTAINING A GROMACS TOPOLOGY WITH AN OFF-CENTER CHARGE

### 1.	Geometry optimization at B3LYP/6-311G(d,p) level;

   starting from a mol2 file which contain a single ligand.
   
   ```
   # Generate the Gaussian input file.
   antechamber -i UNK.mol2 -fi mol2 -o UNK.gjf -fo gcrt -pf y -gn "%nproc=10" -gm "%mem=1500MB" -ch "UNK" -gk "# B3LYP/6-311G(d,p) em=GD3BJ scrf(solvent=water) opt freq" -gv 1 -nc 0 -rn UNK
   #the usage of antechamber could be shown by "antechamber -h"
   
   # Gaussian geometry optimization
   gauss UNK.gjf
   ```
   where, gauss is Gaussian software. It meight be aliased to gauss, g09, g16 in your system.
   
### 2. Single-point electrostatic potential calculation at B3LYP/6-311G(d,p) level;

   ```
   # create Gaussian input file for single-point electrostatic potential calculation
   head -n 4 UNK.gjf > resp.gjf
   echo "# B3LYP/6-311G(d,p) em=GD3BJ scrf(solvent=water) pop=MK IOp(6/33=2,6/42=6) geom=allcheck guess=read" >> resp.gjf
   # B3LYP/6-311G(d,p) can be placed with other functional and basis sets
   head -n 9 UNK.gjf | tail -n 4 >> resp.gjf
   
   # Single-point electrostatic potential calculation
   gauss resp.gjf
   ```

### 3.	Generate mol2 file with RESP charge by antechamber and keep all temporary files;

   ```
   antechamber -i resp.log -fi gout -o lig.mol2 -fo mol2 -c resp -rn UNK -at gaff2
   ```

### 4.	Determine the coordinates of extra points (EP) and generate the GROMACS Topology file with the CGenFF tool;

   In gaussian computation, rotation and translation operations will be applied on molecular coordinates to accelerate calculation. The atom coordinate are changed during the gaussian computation. In this method, you must find the coordinates of extra points by your orginal molecular file (UNK.mol2). Then, align the UNK.mol2 to ligand.mol2. Of course, you also could ban the rotation and translation operations in gaussian software by key word [nosymm](http://gaussian.com/symmetry/#opennewwindow).

   The usage of CGenFF tool is :
   
   ```
   /your/cgenff/installion/path/cgenff_to_gmx.sh mol=UNK.mol2
   ```

### 5. Add the EP coordinates to the ESP file;
      
      The ESP file is a temporary file generated in step 3, normally named ANTECHAMBER.ESP. Because the Merz-Singh-Kollman (MK) Scheme was used in charge fitting, the coordinates in ESP file is proportional scaled from real atomic coordinates. Therefore, the coordinates of EP(s) also need to be scaled with same proportion.
      There are four columns in ANTECHAMBER.ESP. The rows without the first columns are atomic coordinates. Just add new row(s) under these rows.
      Save the new ESP file as ANTECHAMBER_new.ESP.

### 6.	Modify the IN file of resp software;
      
      IN file is another temporary file generated in step 3, normally named ANTECHAMBER_RESP1.IN. Because EP(s) are added to ESP file, the number of atoms is also changed. Therefore, the IN file of resp software also need to be modified.
      First, change the number of atoms.
      Then, add new row(s) at the end of IN file. The number of new row(s) is equal to the EP(s) you added. The content of new row is "    0    0".
      Finally, save the new In file as ANTECHAMBER_RESP1_EP.IN.

### 7.	Refit RESP charges with modified temporary files by resp software;
      
      $AMBERHOME/bin/resp -O -i ANTECHAMBER_RESP1_EP.IN -o ANTECHAMBER_RESP1_EP.out -p ANTECHAMBER_RESP1_EP.pch -t ANTECHAMBER_RESP1_EP.chg -e ANTECHAMBER_new.ESP
      
      the RESP charge is saved in ANTECHAMBER_RESP1_EP.pch.

### 8.	modify GROMACS Topology file;
      
      Replace the charges in the GROMACS Topology file (already generated in step 3) with new RESP charges generated in ANTECHAMBER_RESP1_EP.pch.
      
### 9.	(optional) using GAFF to generate parameters of ligands.
      
      GAFF also could be used to generate parameters of ligands. But the atom type ep must be defined in Amber dat file ($AMBERHOME/dat/antechamber/PARMCHK.DAT). And all parameters of ep in dat file could be set to zero.
      
      9.1 manually create a mol2 file with ep atom, you can just modify the mol2 file generated in step3,
      
      9.2 generate amber parameters with $AMBERHOME/bin/tleap,
      
      9.3 convert amber parameters to gromacs parameters with $AMBERHOME/bin/amb2gro_top_gro.py
      
      9.4 Manually add [exclusions] section in gromacs parameters file, which could be copyed from GROMACS Topology file generated by CGenFF tool.
